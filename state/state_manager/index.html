
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mydomain.org/mysite/state/state_manager/">
      
      
        <link rel="prev" href="../../prompt/">
      
      
      
      <link rel="icon" href="../../assets/celia_logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>State Manager - Cel.ai Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#state-manager" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cel.ai Documentation" class="md-header__button md-logo" aria-label="Cel.ai Documentation" data-md-component="logo">
      
  <img src="../../assets/celia_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cel.ai Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              State Manager
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cel.ai Documentation" class="md-nav__button md-logo" aria-label="Cel.ai Documentation" data-md-component="logo">
      
  <img src="../../assets/celia_logo.png" alt="logo">

    </a>
    Cel.ai Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Connectors
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Connectors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connectors/stream_mode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stream Modes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connectors/webhook_url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Webhook URL with ngrok
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connectors/whatsapp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WhatsApp Connector
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Middlewares
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Middlewares
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../middlewares/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Prompt
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Prompt
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prompt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PromptTemplate Class Documentation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    State
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            State
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    State Manager
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    State Manager
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-the-state-for" class="md-nav__link">
    <span class="md-ellipsis">
      What is the State for?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advantages" class="md-nav__link">
    <span class="md-ellipsis">
      Advantages
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    <span class="md-ellipsis">
      Code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="state-manager">State Manager</h1>
<p>The State Manager in Cel.ai provides a simple and efficient way to store and retrieve state information during a conversation. This feature is crucial for maintaining context and ensuring a seamless user experience.</p>
<h2 id="what-is-the-state-for">What is the State for?</h2>
<p>The state in a conversation refers to the information that is relevant to the current context of the conversation. For example, if the user asks a question and the assistant needs to look up information to provide an answer, the state can be used to store the question and the information retrieved so that the assistant can refer back to it later in the conversation.</p>
<p>For example, if the user asks for how much money they have in their account, the assistant can store the user's account balance in the state, then Cel.ai can inject that information into the prompt before processing the inference.</p>
<p><code>PromptTemplate</code> can reference any key-value pair stored in the state. For example, if the state contains the key <code>account_balance</code>, the <code>PromptTemplate</code> can reference it as <code>{{account_balance}}</code>.</p>
<h2 id="advantages">Advantages</h2>
<ul>
<li><strong>Automatic State Management</strong>: The state is automatically saved and committed when using the <code>async with</code> block.</li>
<li><strong>Error Handling</strong>: If an error occurs within the <code>async with</code> block, the state changes are rolled back, ensuring data integrity.</li>
<li><strong>Simplicity</strong>: The state is managed as a simple key-value store, making it easy to use and understand.</li>
<li><strong>Data Persistence</strong>: The state is persisted across multiple messages and sessions, allowing for continuity in the conversation.</li>
</ul>
<h2 id="usage">Usage</h2>
<p>To use the State Manager, you need to access it via the <code>RequestContext</code> or <code>FunctionContext</code> object. Here is an example of how to use it within an event handler for a message event:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cel.assistants.request_context</span> <span class="kn">import</span> <span class="n">RequestContext</span>

<span class="nd">@ast</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got message event: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Using the state manager within an async with block</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

    <span class="c1"># Send a response</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">lead</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Message count: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cancel_ai_response</span><span class="p">()</span>
</code></pre></div>
<h2 id="example">Example</h2>
<p>Here is a complete example demonstrating how to use the State Manager to count the number of messages received from a user:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">cel.connectors.telegram</span> <span class="kn">import</span> <span class="n">TelegramConnector</span>
<span class="kn">from</span> <span class="nn">cel.gateway.message_gateway</span> <span class="kn">import</span> <span class="n">MessageGateway</span><span class="p">,</span> <span class="n">StreamMode</span>
<span class="kn">from</span> <span class="nn">cel.message_enhancers.smart_message_enhancer_openai</span> <span class="kn">import</span> <span class="n">SmartMessageEnhancerOpenAI</span>
<span class="kn">from</span> <span class="nn">cel.assistants.macaw.macaw_assistant</span> <span class="kn">import</span> <span class="n">MacawAssistant</span>
<span class="kn">from</span> <span class="nn">cel.prompt.prompt_template</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span> <span class="nn">cel.assistants.request_context</span> <span class="kn">import</span> <span class="n">RequestContext</span>

<span class="c1"># Load environment variables</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Setup prompt</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;You are an assistant called Celia. Keep responses short and to the point. Don&#39;t use markdown formatting in your responses.&quot;</span>
<span class="n">prompt_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

<span class="c1"># Create the assistant</span>
<span class="n">ast</span> <span class="o">=</span> <span class="n">MacawAssistant</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">)</span>

<span class="c1"># Event handler for the message event</span>
<span class="nd">@ast</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got message event: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Using the state manager within an async with block</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

    <span class="c1"># Send a response</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">lead</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Message count: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cancel_ai_response</span><span class="p">()</span>

<span class="c1"># Create the Message Gateway</span>
<span class="n">gateway</span> <span class="o">=</span> <span class="n">MessageGateway</span><span class="p">(</span>
    <span class="n">assistant</span><span class="o">=</span><span class="n">ast</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5004</span><span class="p">,</span>
    <span class="n">message_enhancer</span><span class="o">=</span><span class="n">SmartMessageEnhancerOpenAI</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Use the Telegram connector</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">TelegramConnector</span><span class="p">(</span>
    <span class="n">token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TELEGRAM_TOKEN</span>

<span class="s2">&quot;),</span>


    <span class="n">stream_mode</span><span class="o">=</span><span class="n">StreamMode</span><span class="o">.</span><span class="n">FULL</span>
<span class="p">)</span>
<span class="n">gateway</span><span class="o">.</span><span class="n">register_connector</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

<span class="c1"># Start the gateway</span>
<span class="n">gateway</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">enable_ngrok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h2 id="best-practices">Best Practices</h2>
<ul>
<li><strong>Use <code>async with</code> Block</strong>: Always use the <code>async with</code> block for state management to ensure automatic saving and error handling.</li>
<li><strong>Avoid Manual State Saving</strong>: While you can manually save the state using <code>await state.save_state()</code>, it is recommended to rely on the <code>async with</code> block for simplicity and reliability.</li>
<li><strong>Handle Errors Gracefully</strong>: If an error occurs within the <code>async with</code> block, the state changes will be rolled back, ensuring data integrity.</li>
</ul>
<p>By following these best practices, you can effectively manage state in your Cel.ai assistant, providing a robust and seamless user experience.</p>
<p>alejamp: crea un archivo .md con eso</p>
<p>GitHub Copilot: ### Plan</p>
<ol>
<li>Create a new Markdown file named <code>assistant.md</code>.</li>
<li>Copy the provided Python code and comments into the Markdown file.</li>
<li>Format the content appropriately using Markdown syntax.</li>
</ol>
<h3 id="code">Code</h3>
<p><div class="highlight"><pre><span></span><code><span class="gh"># State Management with Cel.ai</span>

This is a simple example of an AI Assistant implemented using the Cel.ai framework. It serves as a basic demonstration of how to get started with Cel.ai for creating intelligent assistants.

<span class="gs">**Framework**</span>: Cel.ai  
<span class="gs">**License**</span>: MIT License

This script is part of the Cel.ai example series and is intended for educational purposes.

<span class="gu">## Usage</span>

Configure the required environment variables in a <span class="sb">`.env`</span> file in the root directory of the project. The required environment variables are:
<span class="k">-</span><span class="w"> </span><span class="sb">`WEBHOOK_URL`</span>: The webhook URL for the assistant, you can use ngrok to create a public URL for your local server.


-

 <span class="sb">`TELEGRAM_TOKEN`</span>: The Telegram bot token for the assistant. You can get this from the BotFather on Telegram.

Then run this script to see a basic AI assistant in action.

<span class="gs">**Note**</span>: Please ensure you have the Cel.ai framework installed in your Python environment prior to running this script.

<span class="gu">## Code</span>

```python
<span class="gh"># LOAD ENV VARIABLES</span>
import asyncio
import os
from loguru import logger as log
<span class="gh"># Load .env variables</span>
from dotenv import load_dotenv
load_dotenv()

<span class="gh"># REMOVE THIS BLOCK IF YOU ARE USING THIS SCRIPT AS A TEMPLATE</span>
<span class="gh"># -------------------------------------------------------------</span>
import sys
from pathlib import Path
<span class="gh"># Add parent directory to path</span>
path = Path(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(str(path.parents[1]))
<span class="gh"># -------------------------------------------------------------</span>

<span class="gh"># Import Cel.ai modules</span>
from cel.connectors.telegram import TelegramConnector
from cel.gateway.message_gateway import MessageGateway, StreamMode
from cel.message_enhancers.smart_message_enhancer_openai import SmartMessageEnhancerOpenAI
from cel.assistants.macaw.macaw_assistant import MacawAssistant
from cel.prompt.prompt_template import PromptTemplate
from cel.assistants.request_context import RequestContext

<span class="gh"># Setup prompt</span>
prompt = &quot;You are an assistant called Celia. Keep responses short and to the point.\
Don&#39;t use markdown formatting in your responses.&quot;

prompt_template = PromptTemplate(prompt)

<span class="gh"># Create the assistant based on the Macaw Assistant </span>
<span class="gh"># NOTE: Make sure to provide api key in the environment variable `OPENAI_API_KEY`</span>
<span class="gh"># add this line to your .env file: OPENAI_API_KEY=your-key</span>
<span class="gh"># or uncomment the next line and replace `your-key` with your OpenAI API key</span>
<span class="gh"># os.environ[&quot;OPENAI_API_KEY&quot;] = &quot;your-key..&quot;</span>
ast = MacawAssistant(prompt=prompt_template)

<span class="gh"># Event handler for the message event</span>
<span class="gh"># This example demonstrates how to use the state manager to store and retrieve state</span>
<span class="gh"># Count the number of messages received from the user and send a response with the count</span>
<span class="gh"># ---------------------------------------------------------------------------</span>
<span class="ni">@ast</span>.event(&#39;message&#39;)
async def handle_message(session, ctx: RequestContext):
    log.debug(f&quot;Got message event: {ctx.message}&quot;)

    # State Manager: Celai provides a simple way to store and retrieve state
    # for the conversation. The state is accessible via ctx.state_manager()
    # For example: ctx.state_manager() returns an AsyncStateManager object
    # which can be used to store and retrieve state for the conversation.
    async with ctx.state_manager() as state:
        count = state.get(&quot;count&quot;, 0)
        count += 1
        state[&quot;count&quot;] = count
        # Add more logic and changes to the state here
        # For example: state[&quot;key&quot;] = value
        # The state is a simple key-value store that can be used to store
        # any data related to the conversation.

    # Once you leave the async with block, the state will be automatically saved
    # and committed to the state store.

    # You can still access the state outside the async with block
    # but you won&#39;t be able to save changes to the state automatically
    # If you need to save changes to the state outside the async with block
    # you can call: await state.save_state()

    # We strongly recommend using the async with block for state management

    # If a error occurs inside the async with block, the state will not be saved
    # and the changes will be rolled back.So you can safely use the async with block

    # Send a response
    await ctx.connector.send_text_message(ctx.lead, f&quot;Message count: {count}&quot;)
    return ctx.cancel_ai_response()
<span class="gh"># ---------------------------------------------------------------------------</span>

<span class="gh"># Create the Message Gateway - This component is the core of the assistant</span>
<span class="gh"># It handles the communication between the assistant and the connectors</span>
gateway = MessageGateway(
    assistant=ast,
    host=&quot;127.0.0.1&quot;, port=5004,
    message_enhancer=SmartMessageEnhancerOpenAI()
)

<span class="gh"># For this example, we will use the Telegram connector</span>
conn = TelegramConnector(
    token=os.environ.get(&quot;TELEGRAM_TOKEN&quot;), 
    stream_mode=StreamMode.FULL
)
<span class="gh"># Register the connector with the gateway</span>
gateway.register_connector(conn)

<span class="gh"># Then start the gateway and begin processing messages</span>
<span class="gh"># gateway.run()</span>
gateway.run(enable_ngrok=True)
</code></pre></div>
```</p>
<p>Save this content into a file named <code>assistant.md</code>.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2024 Cel.ai - All Rights Reserved
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/cel-ai/celai" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>